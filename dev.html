<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="img/favicon.ico">
        <title>Python Scripts - AI Frameworks</title>
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link href="css/font-awesome.min.css" rel="stylesheet">
        <link href="css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/docco.min.css">

        <script src="js/jquery-1.10.2.min.js" defer></script>
        <script src="js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="index.html">AI Frameworks</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="index.html" class="nav-link">Home</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Courses <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="introduction.html" class="dropdown-item">Course Introduction</a>
</li>
                                    
<li>
    <a href="git_intro.html" class="dropdown-item">Introduction to Git</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Development tools for Data Scientist</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="dev.html" class="dropdown-item active">Python Scripts</a>
</li>
            
<li>
    <a href="gcloud_set_up.html" class="dropdown-item">Set up GCoud</a>
</li>
            
<li>
    <a href="gcloud.html" class="dropdown-item">Introduction to GCloud</a>
</li>
            
<li>
    <a href="docker.html" class="dropdown-item">Introduction to Docker</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="schedule.html" class="nav-link">Schedule</a>
                            </li>
                            <li class="navitem">
                                <a href="evaluation.html" class="nav-link">Evaluation</a>
                            </li>
                            <li class="navitem">
                                <a href="https://github.com/wikistat/AI-Frameworks" class="nav-link">Github repository</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="git_intro.html" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="gcloud_set_up.html" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#development-for-data-scientist" class="nav-link">Development for Data Scientist:</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#pytorch-and-python-script" class="nav-link">Pytorch and Python Script</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#course" class="nav-link">Course</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#course-notebook" class="nav-link">Course notebook:</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#practical-session" class="nav-link">Practical session</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#practical-session-repository" class="nav-link">Practical session repository:</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#the-network-class" class="nav-link">The network class:</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#the-training-script" class="nav-link">The training script</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#monitoring-and-experiment-management" class="nav-link">Monitoring and experiment management</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#deploying-your-model-with-gradio" class="nav-link">Deploying your model with Gradio</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#git" class="nav-link">Git</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="development-for-data-scientist">Development for Data Scientist:</h1>
<h2 id="pytorch-and-python-script">Pytorch and Python Script</h2>
<hr />
<h2 id="course">Course</h2>
<iframe width="560" height="315" src="https://www.youtube.com/embed/RXmabok7Xpg" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<!-- *   [Slides](https://github.com/wikistat/AI-Frameworks/raw/master/slides/Code_Development_Python.pdf) -->
<!-- *   [Practical session](https://github.com/wikistat/AI-Frameworks/blob/master/CodeDevelopment/TP.pdf) -->

<h2 id="course-notebook">Course notebook:</h2>
<p><a href="https://minhaskamal.github.io/DownGit/#/home?url=https://github.com/wikistat/AI-Frameworks/blob/website/code/developpement/intro_pytorch.ipynb">Notebook</a><br />
<a href="https://colab.research.google.com/github/wikistat/AI-Frameworks/blob/website/code/developpement/intro_pytorch.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg" /></a></p>
<h2 id="practical-session">Practical session</h2>
<p>For this session, you will have to write a script to train a small neural network on the MNIST dataset using Pytorch.<br />
During training, you will use tensorboard to:</p>
<ul>
<li>monitor your network across epochs</li>
<li>manage your experiments and hyper-parameters  </li>
<li>provide some visualizations.</li>
</ul>
<!-- The solution is available here.  [![Open In Colab](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/github/DavidBert/N7-techno-IA/blob/master/code/developpement/MNIST_solution.ipynb)  
Try to complete the practical session without looking at it! -->

<h2 id="practical-session-repository">Practical session repository:</h2>
<p>If you haven't already done so, create an account on <a href="https://github.com/">Github</a>.
Then fork <a href="https://github.com/DavidBert/ModIA_TP1">this repository</a> and clone it on your computer.<br />
<img alt="" src="img/code/fork.png" /></p>
<h2 id="the-network-class">The network class:</h2>
<p><img alt="" src="img/Mnist_net.png" /></p>
<p>Using the figure above, fill in the following code, in the <code>mnist_net.py</code> file, to create the network class:  </p>
<ul>
<li>The method <code>__init__()</code> should instantiate all the layers that will be used  by the network.</li>
<li>The method <code>forward()</code> describes the forward graph of your network. All the pooling operations and activation functions are realized in this method. Do not forget to change the shape of your input before the first linear layer using <code>torch.flatten(...)</code> or <code>x.view(...)</code>.</li>
</ul>
<pre><code class="language-python">import torch
import torch.nn as nn
import torch.nn.functional as F

class MNISTNet(nn.Module):
    def __init__(self):
        super(MNNISTNet, self).__init__()
        self.conv1 = nn.Conv2d(...)
        self.conv2 = nn.Conv2d(...)
        self.pool = nn.MaxPool2d(...)
        self.fc1 = nn.Linear(...)
        self.fc2 = nn.Linear(...)
        self.fc3 = nn.Linear(...)

    def forward(self, x):
        x = F.relu(self.conv1(x))       # First convolution followed by
        x = self.pool(x)                # a relu activation and a max pooling#
        x = ...
        ...
        x = self.fc3(x)
        return x
</code></pre>
<h2 id="the-training-script">The training script</h2>
<p>The previous file contained our model class. We will now complete the training script <code>train_mnist.py</code>.
This file will be used as a python script to train a neural network on the MNIST Dataset.<br />
The <code>train()</code> and <code>test()</code> methods are already implemented.</p>
<pre><code class="language-python">import argparse
from statistics import mean

import torch
import torchvision
import torchvision.transforms as transforms
import torch.nn as nn
import torch.nn.functional as F
import torch.optim as optim
from tqdm import tqdm

from models import MNISTNet

 # setting device on GPU if available, else CPU
  device = torch.device('cuda' if torch.cuda.is_available() else 'cpu')

def train(net, optimizer, loader, epochs=10):
    criterion = nn.CrossEntropyLoss()
    for epoch in range(epochs):
        running_loss = []
        t = tqdm(loader)
        for x, y in t:
            x, y = x.to(device), y.to(device)
            outputs = net(x)
            loss = criterion(outputs, y)
            running_loss.append(loss.item())
            optimizer.zero_grad()
            loss.backward()
            optimizer.step()
            t.set_description(f'training loss: {mean(running_loss)}')

def test(model, dataloader):
    test_corrects = 0
    total = 0
    with torch.no_grad():
        for x, y in dataloader:
            x = x.to(device)
            y = y.to(device)
            y_hat = model(x).argmax(1)
            test_corrects += y_hat.eq(y).sum().item()
            total += y.size(0)
    return test_corrects / total
</code></pre>
<p>We will now implement the <code>main</code> method that will be called every time the python script is executed.<br />
We would like to give the user the possibility to adjust some parameters of the learning process, such as:</p>
<ul>
<li>The batch size</li>
<li>The learning rate</li>
<li>The number of training epochs</li>
</ul>
<p>To do so we will use Python <a href="https://docs.python.org/3/library/argparse.html">argparse module</a>. This module is used to write user-friendly command-line interfaces.<br />
Adding an argument to a python script using <strong>argaparse</strong> is pretty straightforward.<br />
First you need to import the argparse module and instanciate a parser within the <code>main</code> method:</p>
<pre><code class="language-python">import argparse

if __name__=='__main__':
  parser = argparse.ArgumentParser()
</code></pre>
<p>Then, just add a new argument to the parser precising the argument's name, its type, and optionaly a default value and an helping message.</p>
<pre><code class="language-python">  parser.add_argument('--exp_name', type=str, default = 'MNIST', help='experiment name')
</code></pre>
<p>Finaly, you can use the arguments in the script by using an <code>args</code> variable.</p>
<pre><code class="language-python">  args = parser.parse_args()
  print(args.exp_name)
</code></pre>
<p>Complete the main method to parse the four possible arguments provided when executing the script:</p>
<pre><code class="language-python">if __name__=='__main__':

  parser = argparse.ArgumentParser()

  parser.add_argument('--exp_name', type=str, default = 'MNIST', help='experiment name')
  parser.add_argument(...)
  parser.add_argument(...)
  parser.add_argument(...)

  args = parser.parse_args()
  exp_name = args.exp_name
  epochs = ...
  batch_size = ...
  lr = ...
</code></pre>
<p>The following code instantiates two <a href="https://pytorch.org/tutorials/beginner/basics/data_tutorial.html">data loaders</a>: one loading data from the training set, the other one from the test set.</p>
<pre><code class="language-python"># transforms
  transform = transforms.Compose(
      [transforms.ToTensor(),
      transforms.Normalize((0.5,), (0.5,))])

  # datasets
  trainset = torchvision.datasets.MNIST('./data', download=True, train=True, transform=transform)
  testset = torchvision.datasets.MNIST('./data', download=True, train=False, transform=transform)

  # dataloaders
  trainloader = torch.utils.data.DataLoader(trainset, batch_size=batch_size, shuffle=True, num_workers=2)
  testloader = torch.utils.data.DataLoader(testset, batch_size=batch_size, shuffle=False, num_workers=2)
</code></pre>
<p>Instantiate a MNISTNet and a <a href="https://pytorch.org/docs/stable/generated/torch.optim.SGD.html">SGD optimizer</a> using the learning rate provided in the script arguments and use the train method to train your network and the test method to compute the test accuracy. </p>
<pre><code class="language-python">  net = ...
  # setting net on device(GPU if available, else CPU)
  net = net.to(device)
  optimizer = optim.SGD(...)

  train(...)
  test_acc = test(...)
  print(f'Test accuracy:{test_acc}')
</code></pre>
<p>Finally, save your model using the <code>torch.save</code> method.</p>
<pre><code class="language-python">  torch.save(net.state_dict(), 'mnist_net.pth')
</code></pre>
<p>You should now be able to run your python script using the following command in your terminal:</p>
<pre><code>python train_mnist.py --epochs=5 --lr=1e-3 --batch_size=64
</code></pre>
<h2 id="monitoring-and-experiment-management">Monitoring and experiment management</h2>
<p>Training our model on MNIST is pretty fast.
Nonetheless, in most cases, training a network may be very long.
For such cases, it is essential to log partial results during training to ensure that everything is behaving as expected.<br />
A very famous tool to monitor your experiments in deep learning is Tensorboard.<br />
The main object used by Tensorboard is a <code>SummaryWriter</code>.<br />
Add the following import:</p>
<pre><code class="language-python">from torch.utils.tensorboard import SummaryWriter
</code></pre>
<p>and modify the train method to take an additional argument named <code>writer</code>. Use its <code>add_scalar</code> method to log the training loss for every epoch.</p>
<pre><code class="language-python">def train(net, optimizer, loader, writer, epochs=10):
    criterion = nn.CrossEntropyLoss()
    for epoch in range(epochs):
        running_loss = []
        t = tqdm(loader)
        for x, y in t:
            x, y = x.to(device), y.to(device)
            outputs = net(x)
            loss = criterion(outputs, y)
            running_loss.append(loss.item())
            optimizer.zero_grad()
            loss.backward()
            optimizer.step()
            t.set_description(f'training loss: {mean(running_loss)}')
        writer.add_scalar('training loss', mean(running_loss), epoch)
</code></pre>
<p>In the <code>main</code> method instantiate a <code>SummaryWriter</code> with </p>
<pre><code class="language-python">writer = SummaryWriter(f'runs/MNIST')
</code></pre>
<p>and add it as argument to the <code>train</code> method.<br />
Re-run your script and check your tensorboard logs using in a separate terminal:</p>
<pre><code class="language-bash">tensorboard --logdir runs
</code></pre>
<p>You can use tensorboard to log many different things such as your network computational graph, images, samples from your dataset, embeddings, or even use it for experiment management.  </p>
<p>Add a new method to the MNISTNet class to get the embeddings computed after the last convolutional layer.</p>
<pre><code class="language-python">def get_features(self, x):
        x = self.pool(F.relu(self.conv1(x)))
        x = self.pool(F.relu(self.conv2(x)))
        x = x.view(-1, 16 * 4 * 4)
        return x
</code></pre>
<p>Now these following code to the end of your <code>main</code> function to log the embeddings and the computational graph in tensorboard. </p>
<pre><code class="language-python">  #add embeddings to tensorboard
  perm = torch.randperm(len(trainset.data))
  images, labels = trainset.data[perm][:256], trainset.targets[perm][:256]
  images = images.unsqueeze(1).float().to(device)
  with torch.no_grad():
    embeddings = net.get_features(images)
    writer.add_embedding(embeddings,
                  metadata=labels,
                  label_img=images, global_step=1)

  # save networks computational graph in tensorboard
  writer.add_graph(net, images)
  # save a dataset sample in tensorboard
  img_grid = torchvision.utils.make_grid(images[:64])
  writer.add_image('mnist_images', img_grid)
</code></pre>
<p>Re-run your script and restart tensorboard. <br />
Visualize the network computational graph by clicking on <strong>Graph</strong>.<br />
You should see something similar to this:
<img alt="" src="img/tensorboard_2.png" /></p>
<p>Click on the <strong>inactive</strong> button and choose <strong>projector</strong> to look at the embeddings computed by your network
<img alt="" src="img/tensorboard_3.png" />
<img alt="" src="img/tensorboard_4.png" />
<img alt="" src="img/tensorboard_6.png" /></p>
<h2 id="deploying-your-model-with-gradio">Deploying your model with Gradio</h2>
<p>We will now create a simple application to guess the numbers drawn by a user from our saved model.<br />
We will use the <a href="https://gradio.app/">Gradio</a> library to quickly prototype machine learning applications and demonstrations with user friendly web interfaces.</p>
<p>Install the library:</p>
<pre><code class="language-bash">pip install gradio
</code></pre>
<p>Creating an application with Gradio is done through the use of its Interface class
The core Interface class is initialized with three required parameters:</p>
<ul>
<li>fn: the function to wrap a user interface around</li>
<li>inputs: which component(s) to use for the input, e.g. "text" or "image" or "audio"</li>
<li>outputs: which component(s) to use for the output, e.g. "text" or "image" "label"</li>
</ul>
<p>Gradio includes more than <a href="https://gradio.app/docs/#components">20 different components</a>, most of which can be used as inputs or outputs.</p>
<p>In this example, we will use a <em>sketchpad</em> (which is an instance of the <a href="https://gradio.app/docs/#image"><em>Image</em> component</a>)component for the input and a <a href="https://gradio.app/docs/#label"><em>Label</em> component</a>  for the output.</p>
<pre><code class="language-python">gr.Interface(fn=recognize_digit, 
            inputs=&quot;sketchpad&quot;, 
            outputs=gr.outputs.Label(num_top_classes=3),
            live=True,
            description=&quot;Draw a number on the sketchpad to see the model's prediction.&quot;,
            ).launch(debug=True, share=True);
</code></pre>
<p>Complete the <code>mnist_app.py</code> file so that the weights path is provided by the user and run your application with the following command:</p>
<pre><code class="language-bash">python mnist_app.py --weights_path [path_to_the weights]
</code></pre>
<p>Is your model accurate with your drawings?
Do you know why it is less accurate than on MNIST?</p>
<h2 id="git">Git</h2>
<p>Commit all the modifications you have made to the repository as well as the weights and push them to your remote repository.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = ".",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="js/base.js" defer></script>
        <script src="javascripts/mathjax.js" defer></script>
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6" defer></script>
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
        <script src="search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
